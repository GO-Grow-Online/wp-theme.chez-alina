{% set current_day_num = "now"|date("N") %}
{% set current_time = "now"|date("H:i") %}

{% set day_slug = {
    1: "monday",
    2: "tuesday",
    3: "wednesday",
    4: "thursday",
    5: "friday",
    6: "saturday",
    7: "sunday"
} %}

{% set is_open = false %}
{% set next_hour = null %}

{# Vérifie si le lieu est fermé globalement #}
{% if schedules.is_closed == false %}

    {# Vérifie les horaires d'aujourd'hui #}
    {% set today_schedules = schedules[day_slug[current_day_num]] %}
    {% if today_schedules is not empty %}
        {% for schedule in today_schedules %}
            {% set open_time = schedule.opening %}
            {% set close_time = schedule.closing %}

            {# Si on est dans une plage horaire ouverte actuellement #}
            {% if current_time >= open_time and current_time < close_time %}
                {% set is_open = true %}
                {% set next_hour = close_time %}
            {% endif %}

            {# Si on est avant une plage horaire ouverte plus tard dans la journée #}
            {% if current_time < open_time and (next_hour is null or open_time < next_hour) %}
                {% set next_hour = open_time %}
            {% endif %}
        {% endfor %}
    {% endif %}

    {# Si on n'a trouvé aucune ouverture pour aujourd'hui, chercher dans les jours suivants #}
    {% if not is_open and next_hour is null %}
        {% for i in range(1, 7) %}
            {% set next_day_num = (current_day_num + i - 1) % 7 + 1 %}
            {% set next_day_slug = day_slug[next_day_num] %}
            {% if schedules[next_day_slug] is not empty %}
                {% set next_hour = schedules[next_day_slug][0].opening %}
                {% break %}
            {% endif %}
        {% endfor %}
    {% endif %}

{% else %}
    {% set is_open = false %}
{% endif %}






{# Affichage de l'état du restaurant #}
{% set status = is_open ? pll('ouvert', 'Non editable strings') : pll('fermé', 'Non editable strings') %}
{% set classes = is_open ? 'btn-succes' : 'btn-failed' %}
{% set status = pll('Nous sommes ', 'Non editable strings') ~ "<strong> " ~ status  ~ " </strong>" %}


{# If Closed is true then set other strings #}
{% if schedules.is_closed == false %}

    {% set text = is_open ? pll("Fermeture") : pll("Ouverture") %}
    {% set text = text ~ "&nbsp;" ~ pll(' à ') ~ "&nbsp;" ~ next_hour %}

{% else %}

    {% set text = schedules.is_closed_text is not empty ? schedules.is_closed_text : pll('Nous sommes momentanément fermés.' ) %}

{% endif %}

<span class="realTime_schedule">
    <span class="realTime_schedule-btn btn {{ classes }}">
        <span class="icon">{% include "assets/static/svg/icons/clock.svg" %}</span>
        <span>{{ status }}</span>
    </span>

    <small>{{ text }}</small>
</span>
